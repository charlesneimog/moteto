<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title style="text-align: center;">Moteto</title>
        <video id="screenOn" autoplay style="height: 2px; width: 2px; position: absolute; top: 0; left: 0; z-index: -1;" controls muted> </video>
    </head>
    <body id="mainBody">
        <script>
            var host = window.location.hostname;
            var onWebSite = false;
            var thisNaipe = undefined;
            if (host.includes("charlesneimog.com")){
                onWebSite = true;
            }    
        </script>

        <script await src="./public/permitionRequests.js"> </script>
        <script await src="./public/functions.js"> </script>
                
        <link rel="stylesheet" type="text/css" href="public/style.css">
        <h1 id="PageTitle" style="text-align: center;">Moteto</h1>
        <label id="message4choosenaipe" for="naipe-select" style="position: absolute; left: 50%; transform: translateX(-50%); text-align: center;"></label>
        <select id="naipe-select" onchange="chooseNaipe()" style="position: absolute; left: 50%; transform: translateX(-50%);"> 
            <option value="none">Selecione o seu naipe de voz.</option>
            <option value="Soprano">Soprano</option>
            <option value="Contralto">Contralto</option>
            <option value="Tenor">Tenor</option>
            <option value="Baixo">Baixo</option>
        </select>
        <select id="minute-select" onchange="chooseMinute()" style="position: absolute; left: 50%; transform: translateX(-50%);"> 
            <option id="minute-select-none" value="none">Selecione o horário para início da obra.</option>
            <option id="minute-select-0" value="0">0</option>
            <option id="minute-select-1" value="1">1</option>
            <option id="minute-select-2" value="2">2</option>
            <option id="minute-select-3" value="3">3</option>
            <option id="minute-select-4" value="4">4</option>
            <option id="minute-select-5" value="5">5</option>
            <option id="minute-select-6" value="6">6</option>
            <option id="minute-select-7" value="7">7</option>
            <option id="minute-select-8" value="8">8</option>
            <option id="minute-select-9" value="9">9</option>
        </select>
        <script>
            var thisMinutDec = Math.floor(new Date().getMinutes() / 10) * 10; // decimal of 10 minutes
            var thisMinutUnit = new Date().getMinutes() % 10; // unit of 10 minutes    
            var thisMinut = parseInt(thisMinutDec.toString()) + parseInt(thisMinutUnit.toString());
            for (i = 0; i < 10; i++){
                const minuteSelect = document.getElementById("minute-select-" + i.toString());
                minuteSelect.value = parseInt(thisMinut) + 1 + i; 
                thisHour = new Date().getHours();
                minuteSelect.innerHTML = "Iniciar obra às " + thisHour + ":" + ((parseInt(thisMinut) + 1 + i) % 60).toString().padStart(2, '0') + ".";
            }
            // hidde naipe-select
            const naipeSelectionStart = document.getElementById("naipe-select");
            naipeSelectionStart.style.display = "none";

        </script>
        <img id="imgNote" style="position: absolute; left: 50%; transform: translateX(-50%); max-width: 95%; max-height: 50vh; width: auto; height: auto;" src="public/none.png" alt="Note">
        <h4 id="completePhrase" style="text-align: center; position: relative;"></h4>
        <br>
        <h4 id="infoPhrase" style="text-align: center; position: relative;"></h4>
        <script id="eventScript" src="./public/events.js"></script> 
        <script>

            window.pieceEvents = [];
            // set naipe-select and minute-select asinline-block" none
            var naipeSelection = document.getElementById("naipe-select");
            var minuteSelection = document.getElementById("minute-select");
            var infoPhrase = document.getElementById("infoPhrase");
            var img = document.getElementById("imgNote");

            naipeSelection.value = "none";
            minuteSelection.value = "none";
            
            const naipeSelectionPos = minuteSelection.getBoundingClientRect();
            img.style.top = `${naipeSelectionPos.bottom + 60}px`;

            const imgNote = document.getElementById('imgNote');
            imgNote.addEventListener('click', function() {
                const select = document.getElementById("minute-select");
                select.focus();
                
            });
            // add completePhrase after imgNote
            var completePhrase = document.getElementById("completePhrase");
            imgNote.addEventListener("load", function() {
                var imgNotePos = imgNote.getBoundingClientRect();
                var imgNoteWidth = imgNotePos.width;
                var imgNoteHeight = imgNotePos.height;
                completePhrase.style.position = "absolute";
                completePhrase.style.top = `${imgNotePos.bottom + 20}px`;
                completePhrase.style.textAlign = "center";
                var completePhraseBound = completePhrase.getBoundingClientRect();
                infoPhrase.innerHTML = "Todos os(as) performers devem escolher o mesmo minuto para iniciar a obra.";
                infoPhrase.style.fontStyle = "italic";
                infoPhrase.style.fontWeight = "normal";
                infoPhrase.style.position = "relative";
                infoPhrase.style.color = "#21A5FF";
                // put this infoPhrase below the Title
                infoPhrase.style.top = `${imgNotePos.top - 170}px`;

            });

        
            function checkCompatibility(){
                if (typeof navigator === "undefined" || typeof navigator.userAgent === "undefined") {
                    alert("navigator.userAgent is undefined");
                    return;
                }
                let userAgent = navigator.userAgent;
                let browserName;
                 
                if(userAgent.match(/chrome|chromium|crios/i)){
                    browserName = "chrome";
                }
                else if(userAgent.match(/firefox|fxios/i)){
                    browserName = "firefox";
                    const isMobile = navigator.userAgent.mobile;
                    if (isMobile){
                        alert("O navegador Firefox não parece ser compatível com algumas de nossas funcionalidades. Para melhor experiência altere o navegador.");
                    }
                }  
                else if(userAgent.match(/safari/i)){
                    browserName = "safari";
                }
                else if(userAgent.match(/opr\//i)){
                    browserName = "opera";
                } 
                else if(userAgent.match(/edg/i)){
                    browserName = "edge";
                }
                else{
                    browserName="No browser detection";
                }
                if (/Mobi|Android/i.test(navigator.userAgent) == true && browserName == "firefox") {
                    alert("O navegador Firefox não parece ser compatível com algumas requisitos de nossa obra (Moteto). Para melhor experiência altere o navegador.");
                }
            }
            checkCompatibility();

            if (/Mobi|Android/i.test(navigator.userAgent) == true) {
                askForFullScreen();
            }

            completePhrase = document.getElementById("completePhrase");
            completePhrase.style.color = "black";
            var imgNotePos = imgNote.getBoundingClientRect();
            var imgNoteWidth = imgNotePos.width;
            var imgNoteHeight = imgNotePos.height;
            completePhrase.style.position = "absolute";
            completePhrase.style.top = `${imgNotePos.bottom + 20}px`;
            sendMessage();

            // set image as none
            // img.src = "./public/begin.png";
            
            function loadCFunctionsFFT() {
                return new Promise((resolve, reject) => {
                    var script = document.createElement('script');
                    script.onload = resolve;
                    script.onerror = reject;
                    script.src = 'public/cFunctions/cFunctions.js';
                    document.head.appendChild(script);
                });
            }
            
            loadCFunctionsFFT();

            function sendMessage() {
                if (onWebSite){
                    return;
                }
                // var xhr = new XMLHttpRequest();
                // var host = window.location.hostname;
                // var port = window.location.port;
                // var protocol = window.location.protocol;
                // var url = protocol + '//' + host + ':' + port + '/send2pd'; // WARNING: This is an standard, all the requests must be sent to this url
                // xhr.open('POST', url, true);
                // xhr.setRequestHeader('Content-Type', 'application/json');
                // const userAgent = navigator.userAgent;
                // const deviceName = userAgent.match(/\(([^)]+)\)/)[1];
                // xhr.send(JSON.stringify({ 'name': deviceName}));
            }

            function chooseNaipe() {
                var selectedNaipe = document.getElementById("naipe-select").value;
                window.naipe = selectedNaipe;
                if (selectedNaipe == "none"){
                    return;
                }
                syncStart();
                setTheNaipe();
                AudioStream(); 
                setTheNaipe();
                img.src = "./public/none.png";

                if (onWebSite){
                    return;
                }
                var xhr = new XMLHttpRequest();
                var host = window.location.hostname;
                var port = window.location.port;
                var protocol = window.location.protocol;
                // var url = protocol + '//' + host + ':' + port + '/send2pd'; // WARNING: This is an standard, all the requests must be sent to this url
                // xhr.open('POST', url, true);
                // xhr.setRequestHeader('Content-Type', 'application/json');
                // const userAgent = navigator.userAgent;
                // const deviceName = userAgent.match(/\(([^)]+)\)/)[1];
                // xhr.send(JSON.stringify({ 'ok': deviceName}));
            }

            function chooseMinute() {
                var selected = document.getElementById("minute-select").value;
                var h4 = document.getElementById("completePhrase");
                h4.style.left = "50%";
                h4.style.transform = "translateX(-50%)";
                infoPhrase.style.display = "none";
                if (selected == "none"){
                    return;
                }
                // img.src = "./public/naipe.png";
                window.startMinute = selected;
                document.getElementById("minute-select").style.display = "none";
                document.getElementById("naipe-select").style.display = "inline-block";

                h4.innerHTML = "Clique para escolher seu naipe!";
                h4.style.color = "#21A5FF";
                if (onWebSite){
                    return;
                }
                
            }

        </script>
        <script src="./public/obra.js"></script>
        <div id="DurationBar" style="position: fixed; bottom: 0; left: 0; width: 0%; height: 20px; background-color: black;"></div>
    </body>
</html>
